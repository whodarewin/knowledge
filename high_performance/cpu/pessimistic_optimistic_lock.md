# 悲观锁乐观锁
---
# 介绍
悲观锁与乐观锁是一种概念上的定义，而不是具体的实现。  
悲观锁指的是对临界资源的访问采取悲观态度，即预测对临界资源的访问大概率会产生访问冲突，而采取先执行加锁操作，后访问资源的方式对临界资源进行访问。  
乐观锁指的是对临界资源的访问采取乐观态度，即预测对临界资源的访问小概率会产生访问冲突，而采取先对临界资源进行访问，然后在更新临界资源的时候检查是否可以更新从而保证资源安全性。
# 实现方式
## 悲观锁
悲观锁的实现大体相同，都是先竞争获得一个锁（此处需要消耗系统资源），获得锁的访问临界资源，未获得锁的等待，等待方式不一，自旋也好挂起也好。
## 乐观锁
CAS，数据库中的MVCC都是这样的乐观实现。
# 各自优缺点
悲观锁适合用在竞争激烈的场合，乐观锁适合用在竞争不激烈的场合。  
原因是悲观锁在上锁的时候，会消耗系统资源，从而拖慢整体进度，降低并发度。  
乐观锁在竞争激烈的情况下，先访问临界资源再使用锁的操作，访问临界资源这块，会出现多次检查不一致，从而导致多次进行基于临界资源的业务逻辑计算，浪费CPU资源。  
# 线程竞争激烈度
线程竞争激烈使用悲观锁，不激烈使用乐观锁，这个没有问题，但在实践上有问题。  
因为如果是通用代码，其实不清楚线程竞争是否太过激烈，这导致无法选择锁的类型。  
现有工程上的做法是先乐观后悲观，乐观锁竞争超过一定周期，升级为悲观锁，例如sync关键字。  
但这又带来了另一个问题，周期如何选择？  
从现在看来，基于线程竞争激烈度统计的自适应选择会是比较好的一个方案。  